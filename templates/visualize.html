{% extends 'base.html' %}
{% block content %}

<section class="py-5 fade-up text-center">
  <div class="container">
    <h1 class="fw-bold mb-4">üìà Resultados da planilha ‚Äî {{ filename }}</h1>

    <!-- Gr√°fico principal -->
    <div class="card bg-dark border-0 shadow-lg p-4 mb-5" style="min-height: 400px;">
      <canvas id="chartCanvas" height="300"></canvas>
    </div>

    <!-- Gr√°ficos comparativos -->
    <h3 class="fw-semibold text-light mb-4">üìä Comparativos por Curso</h3>
    <div class="row text-center mb-5">
      <div class="col-md-4 mb-4">
        <div class="card bg-dark border-0 shadow p-3">
          <h5 class="text-light mb-3">Alunos Matriculados</h5>
          <canvas id="pieAlunos"></canvas>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card bg-dark border-0 shadow p-3">
          <h5 class="text-light mb-3">Satisfa√ß√£o M√©dia</h5>
          <canvas id="pieSatisfacao"></canvas>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card bg-dark border-0 shadow p-3">
          <h5 class="text-light mb-3">Empregabilidade</h5>
          <canvas id="pieEmprego"></canvas>
        </div>
      </div>
    </div>

    <!-- Insights autom√°ticos -->
    <h3 class="fw-semibold text-light mb-3">üí° Insights autom√°ticos</h3>
    <div class="card bg-dark border-0 shadow-lg p-4 text-start mb-5">
      <ul class="list-group list-group-flush">
        {% for item in insights %}
        <li class="list-group-item bg-dark text-light border-secondary">{{ item }}</li>
        {% empty %}
        <li class="list-group-item bg-dark text-muted border-secondary">Nenhum insight dispon√≠vel.</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Tabela -->
    <h3 class="fw-semibold mb-3 text-light">üìã Dados carregados</h3>
    <div class="table-responsive mb-4">
      {{ table_html|safe }}
    </div>

    <a href="{% url 'alfadata:upload' %}" class="btn btn-primary mt-4 px-4">
      ‚¨ÖÔ∏è Enviar outro arquivo
    </a>
  </div>
</section>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // === Gr√°fico principal (linha) ===
  let chartData = {};
  try {
    chartData = JSON.parse('{{ chart_data_json|escapejs }}');
    console.log('‚úÖ Dados principais recebidos:', chartData);
  } catch (e) {
    console.error('‚ùå Erro ao processar JSON do gr√°fico principal:', e);
  }

  if (!chartData || !chartData.datasets || chartData.datasets.length === 0) {
    const container = document.querySelector('.card');
    container.innerHTML = `
      <div class="text-center text-warning py-5">
        <h4>Nenhum dado num√©rico dispon√≠vel üìÑ</h4>
        <p>Verifique se sua planilha cont√©m colunas com valores num√©ricos.</p>
      </div>`;
    return;
  }

  const ctx = document.getElementById('chartCanvas').getContext('2d');

  // Paleta de cores moderna
  function randomColor(i) {
    const palette = [
      'rgba(59,130,246,0.7)',  // azul
      'rgba(34,197,94,0.7)',   // verde
      'rgba(249,115,22,0.7)',  // laranja
      'rgba(236,72,153,0.7)',  // rosa
      'rgba(147,51,234,0.7)',  // roxo
      'rgba(14,165,233,0.7)'   // ciano
    ];
    return palette[i % palette.length];
  }

  chartData.datasets = chartData.datasets.map((ds, i) => ({
    ...ds,
    borderColor: randomColor(i),
    backgroundColor: randomColor(i),
    tension: 0.25,
    fill: false,
    pointRadius: 0
  }));

  new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        decimation: { enabled: true, algorithm: 'min-max', samples: 1000 },
        legend: { position: 'top', labels: { color: '#f8fafc' } },
        title: { display: true, text: 'üìä Gr√°fico gerado a partir do Excel', color: '#f8fafc' }
      },
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          ticks: { color: '#cbd5e1' },
          title: { display: true, text: '√çndice', color: '#cbd5e1' },
          grid: { color: 'rgba(255,255,255,0.05)' }
        },
        y: {
          ticks: { color: '#cbd5e1' },
          title: { display: true, text: 'Valor', color: '#cbd5e1' },
          grid: { color: 'rgba(255,255,255,0.05)' }
        }
      }
    }
  });

  // === Gr√°ficos de Pizza ===
  const pizzaData = JSON.parse('{{ pizza_data_json|escapejs }}');
  const cores = [
    '#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#0ea5e9',
    '#ec4899', '#14b8a6', '#eab308', '#6366f1', '#f97316', '#84cc16'
  ];

  function criaPizza(id, dados) {
    if (!dados || !dados.labels) return;
    const ctxPie = document.getElementById(id).getContext('2d');
    new Chart(ctxPie, {
      type: 'doughnut',
      data: {
        labels: dados.labels,
        datasets: [{ data: dados.data, backgroundColor: cores }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom', labels: { color: '#f8fafc' } }
        }
      }
    });
  }

  criaPizza('pieAlunos', pizzaData.alunos);
  criaPizza('pieSatisfacao', pizzaData.satisfacao);
  criaPizza('pieEmprego', pizzaData.empregabilidade);
});
</script>
{% endblock %}
{% endblock %}
