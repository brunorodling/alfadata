{% extends 'base.html' %}
{% block content %}

<section class="py-5 fade-up text-center">
  <div class="container">
    <h1 class="fw-bold mb-4">ğŸ“ˆ VisualizaÃ§Ã£o â€” {{ filename }}</h1>

    <!-- GrÃ¡fico principal -->
    <div class="card bg-dark border-0 shadow-lg p-4 mb-5" style="min-height: 400px;">
      <canvas id="chartCanvas" height="300"></canvas>
    </div>

    <!-- GrÃ¡fico de barras -->
    <div class="card bg-dark border-0 shadow-lg p-4 mb-5" style="min-height: 400px;">
      <h4 class="text-white mb-4">Comparativo entre colunas</h4>
      <canvas id="chartBarra" height="300"></canvas>
    </div>

    <!-- GrÃ¡fico de pizza -->
    <div class="card bg-dark border-0 shadow-lg p-4 mb-5" style="min-height: 400px;">
      <h4 class="text-white mb-4">DistribuiÃ§Ã£o de mÃ©dias</h4>
      <canvas id="chartPizza" height="300"></canvas>
    </div>

    <!-- Insights -->
    <div class="card bg-light border-0 shadow-sm p-4 mb-5 text-start">
      <h4 class="fw-bold mb-3">ğŸ’¡ Insights AutomÃ¡ticos</h4>
      <ul class="list-unstyled lead">
        {% for item in insights %}
          <li class="mb-2">{{ item|safe }}</li>
        {% empty %}
          <li>Nenhum insight gerado.</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Tabela -->
    <h3 class="fw-semibold mb-3">ğŸ“‹ Dados carregados</h3>
    <div class="table-responsive mb-4">
      {{ table_html|safe }}
    </div>

    <a href="{% url 'alfadata:upload' %}" class="btn btn-primary mt-4 px-4">
      â¬…ï¸ Enviar outro arquivo
    </a>
  </div>
</section>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  let chartData = {};
  try {
    chartData = JSON.parse('{{ chart_data_json|escapejs }}');
  } catch (e) {
    console.error('Erro ao processar JSON:', e);
  }

  if (!chartData.datasets || chartData.datasets.length === 0) return;

  const colors = [
    'rgba(59,130,246,0.7)',
    'rgba(34,197,94,0.7)',
    'rgba(249,115,22,0.7)',
    'rgba(236,72,153,0.7)',
    'rgba(147,51,234,0.7)',
    'rgba(14,165,233,0.7)'
  ];

  const ctxLine = document.getElementById('chartCanvas').getContext('2d');
  const ctxBar = document.getElementById('chartBarra').getContext('2d');
  const ctxPie = document.getElementById('chartPizza').getContext('2d');

  // ğŸ¯ GrÃ¡fico de linhas
  new Chart(ctxLine, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', labels: { color: '#f8fafc' } },
        title: { display: true, text: 'EvoluÃ§Ã£o dos valores', color: '#f8fafc' }
      },
      scales: {
        x: { ticks: { color: '#cbd5e1' } },
        y: { ticks: { color: '#cbd5e1' } }
      }
    }
  });

  // ğŸ¯ GrÃ¡fico de barras (Ãºltimos valores)
  const barras = chartData.datasets.map((d, i) => ({
    label: d.label,
    value: d.data[d.data.length - 1] || 0,
    color: colors[i % colors.length]
  }));

  new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: barras.map(b => b.label),
      datasets: [{
        label: 'Ãšltimo valor',
        data: barras.map(b => b.value),
        backgroundColor: barras.map(b => b.color)
      }]
    },
    options: {
      plugins: { legend: { display: false }, title: { display: true, text: 'Ãšltimos valores por coluna', color: '#f8fafc' } },
      scales: { x: { ticks: { color: '#cbd5e1' } }, y: { ticks: { color: '#cbd5e1' } } }
    }
  });

  // ğŸ¯ GrÃ¡fico de pizza (mÃ©dias por coluna)
  const medias = chartData.datasets.map((d, i) => ({
    label: d.label,
    value: d.data.reduce((a, b) => a + b, 0) / d.data.length,
    color: colors[i % colors.length]
  }));

  new Chart(ctxPie, {
    type: 'pie',
    data: {
      labels: medias.map(m => m.label),
      datasets: [{
        label: 'MÃ©dia',
        data: medias.map(m => m.value),
        backgroundColor: medias.map(m => m.color)
      }]
    },
    options: {
      plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'MÃ©dia por coluna', color: '#f8fafc' } }
    }
  });
});
</script>
{% endblock %}
{% endblock %}
